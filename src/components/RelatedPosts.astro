---
import { getCollection } from "astro:content";
import FormattedDate from "./FormattedDate.astro";

interface Props {
    currentSlug: string;
    currentCategory?: string;
    count?: number;
}

const { currentSlug, currentCategory, count = 3 } = Astro.props;

// Get all posts except current
const allPosts = await getCollection("blog");
let relatedPosts = allPosts.filter(
    (post) => post.id.replace(".md", "") !== currentSlug,
);

// Prefer posts from same category
if (currentCategory) {
    const sameCategoryPosts = relatedPosts.filter(
        (post) => post.data.category === currentCategory,
    );
    const otherPosts = relatedPosts.filter(
        (post) => post.data.category !== currentCategory,
    );

    // Shuffle both arrays
    sameCategoryPosts.sort(() => Math.random() - 0.5);
    otherPosts.sort(() => Math.random() - 0.5);

    // Take from same category first, then fill with others
    relatedPosts = [...sameCategoryPosts, ...otherPosts].slice(0, count);
} else {
    // Just shuffle and take random
    relatedPosts.sort(() => Math.random() - 0.5);
    relatedPosts = relatedPosts.slice(0, count);
}
---

{
    relatedPosts.length > 0 && (
        <section class="related-posts">
            <h2>ðŸ“š Related Articles</h2>
            <div class="related-grid">
                {relatedPosts.map((post) => (
                    <a
                        href={`/${post.id.replace(".md", "")}/`}
                        class="related-card"
                    >
                        <h3>{post.data.title}</h3>
                        <div class="related-meta">
                            <FormattedDate date={post.data.pubDate} />
                            {post.data.category && (
                                <span class="related-category">
                                    {post.data.category}
                                </span>
                            )}
                        </div>
                    </a>
                ))}
            </div>
        </section>
    )
}

<style>
    .related-posts {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-color);
    }

    .related-posts h2 {
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        font-size: 1.35rem;
    }

    .related-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }

    .related-card {
        display: block;
        padding: 1.25rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .related-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
        border-color: var(--accent-primary);
    }

    .related-card h3 {
        color: var(--text-primary);
        font-size: 1rem;
        margin: 0 0 0.75rem;
        line-height: 1.4;
        font-weight: 600;
    }

    .related-card:hover h3 {
        color: var(--accent-primary);
    }

    .related-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .related-category {
        background: #dbeafe;
        color: #1e40af;
        padding: 0.15rem 0.5rem;
        border-radius: 50px;
        font-size: 0.7rem;
        font-weight: 600;
    }
</style>
